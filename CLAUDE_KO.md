# CLAUDE_KO.md

이 파일은 Claude Code (claude.ai/code)가 이 저장소에서 코드 작업을 할 때 한국어 가이드를 제공합니다.

## 프로젝트 개요

이 저장소는 대규모 동시성 환경을 위해 설계된 실시간 동기 쿠폰 발급 시스템을 구현합니다. 100만 명의 잠재적 클라이언트가 1,000개의 한정된 쿠폰을 두고 경쟁하며 즉각적인 성공/실패 응답을 받는 시스템입니다.

## 아키텍처 개요

시스템은 다음과 같은 핵심 구성 요소를 가진 하이브리드 동기/비동기 아키텍처를 사용합니다:

### 핵심 설계 원칙
1. **공격적인 엣지 트래픽 관리** - API 게이트웨이를 사용하여 핵심 서비스에 도달하기 전 트래픽 제어
2. **원자적 인메모리 연산** - 잠금 없는 동시성 제어를 위한 Redis + Lua 스크립팅 (캐시 전용)
3. **분리된 영속성 처리** - Kafka를 사용한 동기 응답과 데이터베이스 쓰기 분리
4. **복원력 및 고가용성** - 다층 장애 허용성 및 복구 메커니즘
5. **캐시 우선 아키텍처** - 핫 데이터 및 원자적 연산을 위한 Redis, 영구 저장을 위한 MySQL

### 시스템 구성 요소
- **API 게이트웨이**: 속도 제한 및 스로틀링 (속도 제한 영역을 가진 NGINX)
- **로드 밸런서**: 수평적 확장 (NGINX 업스트림 로드 밸런싱)
- **애플리케이션 서버**: Docker 컨테이너화된 Python FastAPI
- **Redis 클러스터**: 다중 노드 캐시 및 원자적 연산 (6개 노드: 3개 마스터 + 3개 슬레이브)
- **메시지 큐**: 신뢰할 수 있는 이벤트 스트리밍을 위한 Apache Kafka 클러스터
- **데이터베이스**: 복제 기능이 있는 영구 데이터 저장을 위한 MySQL/MariaDB 클러스터
- **컨슈머 서비스**: Kafka 이벤트를 소비하고 MySQL에 쓰는 Python 서비스

### 요청 흐름
1. 클라이언트 요청 → NGINX API 게이트웨이 (속도 제한) → 로드 밸런서 → FastAPI 앱 서버
2. 앱 서버가 Redis 클러스터에서 원자적 Lua 스크립트 실행 (캐시 + 임시 재고 관리)
3. 클라이언트에게 즉각적인 동기 응답 (성공/실패)
4. 성공 시: 영속성을 위해 Kafka 토픽에 이벤트 발행
5. 컨슈머 서비스가 Kafka 이벤트 처리 → MySQL 데이터베이스에 쓰기
6. Kafka가 메시지 내구성, 파티셔닝, 재시도 메커니즘 처리

## 구현 작업

### 인프라 및 트래픽 관리
- [x] **1. API 게이트웨이 설정** - 토큰 버킷 알고리즘을 사용한 NGINX 속도 제한 및 스로틀링 구성
- [x] **2. 로드 밸런서** - NGINX 업스트림을 사용한 수평적 확장 구성 구현
- [x] **3. Redis 클러스터** - 고가용성을 위한 6개 노드 클러스터(3개 마스터 + 3개 슬레이브) 설계 및 구현

### 핵심 로직 및 데이터 모델
- [x] **4. Redis 캐시 관리** - TTL을 사용한 핫 데이터를 위한 캐시 모델 생성 (`coupon:event_id:stock`)
- [x] **5. MySQL 데이터베이스 스키마** - 쿠폰, 이벤트, 사용자 데이터를 위한 영구 테이블 설계
- [x] **6. Lua 스크립트 개발** - 경쟁 상태 방지를 위한 원자적 쿠폰 발급 개발
- [x] **7. Python 애플리케이션 서버** - Redis 클러스터 및 MySQL 통합으로 FastAPI 구축
- [x] **8. 쿠폰 API 엔드포인트** - 캐시 우선 접근 방식으로 동기식 쿠폰 발급 API 구현

### 영속성 및 메시징
- [x] **9. Kafka 클러스터 설정** - 여러 브로커를 가진 Apache Kafka 클러스터 설정
- [x] **10. Kafka 이벤트 발행** - Kafka 토픽으로의 이벤트 발행 구현
- [x] **11. MySQL 데이터베이스 스키마** - 적절한 인덱싱을 가진 쿠폰, 이벤트, user_coupons 테이블 설계
- [x] **12. 컨슈머 서비스** - Kafka를 소비하고 MySQL에 쓰는 Python 서비스 생성
- [x] **13. 멱등적 데이터베이스 쓰기** - UNIQUE 제약 조건과 적절한 오류 처리로 구현

### 안정성 및 오류 처리
- [x] **14. Kafka 데드 레터 토픽** - 실패한 메시지 처리를 위한 DLT 설정
- [x] **15. 재시도 로직** - 컨슈머 서비스를 위한 지수 백오프 구현
- [ ] **16. 데이터 무결성** - Redis 캐시와 MySQL 간 검증 및 정합성 확인 생성
- [ ] **17. 모니터링** - Kafka 지연, Redis 클러스터 상태, MySQL 메트릭에 대한 알림 설정
- [ ] **18. 클라이언트 오류 처리** - 429/503 오류에 대한 우아한 실패 처리 구현

### 개발 및 운영
- [ ] **19. 부하 테스트** - 포괄적인 성능 튜닝 수행
- [x] **22. Docker 구성** - Docker 구성 파일 생성 (Dockerfile, docker-compose.yml)
- [x] **23. Python 프로젝트 설정** - requirements.txt와 함께 Python 프로젝트 구조 설정

## 핵심 설계 원칙

1. **공격적인 엣지 트래픽 관리** - 토큰 버킷 속도 제한을 사용한 API 게이트웨이를 통해 핵심 서비스에 도달하기 전 트래픽 제어
2. **원자적 인메모리 연산** - 경쟁 상태를 방지하는 잠금 없는 동시성 제어를 위한 Redis + Lua 스크립팅
3. **분리된 영속성 처리** - 성능을 위해 메시지 큐를 사용하여 동기 응답과 데이터베이스 쓰기 분리
4. **복원력 및 고가용성** - DLQ, 재시도 로직, 다중 AZ 배포를 통한 다층 장애 허용성

## 주요 파일

### 애플리케이션 코드
- `app/main.py` - Redis 클러스터 및 Kafka 통합이 있는 FastAPI 애플리케이션 서버
- `app/cache/redis_cluster.py` - Redis 클러스터 클라이언트 및 캐시 연산
- `app/database/models.py` - MySQL 영속성을 위한 SQLAlchemy 모델
- `app/database/connection.py` - 데이터베이스 연결 및 세션 관리
- `app/messaging/kafka_client.py` - Kafka 프로듀서 및 컨슈머 클라이언트
- `app/redis_scripts/coupon_issue_cluster.lua` - 원자적 쿠폰 발급 Lua 스크립트
- `consumer/main.py` - 데이터베이스 영속성을 위한 Kafka 컨슈머 서비스

### 인프라
- `docker-compose.yml` - Redis 클러스터, Kafka, MySQL을 포함한 완전한 오케스트레이션
- `infrastructure/nginx/nginx.conf` - 속도 제한이 있는 API 게이트웨이 구성
- `infrastructure/mysql/init.sql` - 데이터베이스 초기화 스크립트
- `requirements.txt` - Python 의존성

### 문서
- `report.txt` - 상세한 아키텍처 설계 문서 (한국어)
- `TODO.md` - 독립적인 영어 구현 작업 목록
- `TODO_KO.md` - 독립적인 한국어 구현 작업 목록
- `CLAUDE.md` - 이 문서의 영어 버전

## 기술 스택 요구사항

- **프로그래밍 언어**: Python 3.9+
- **웹 프레임워크**: FastAPI
- **캐시**: Redis 클러스터 (6개 노드: 3개 마스터 + 3개 슬레이브)
- **데이터베이스**: 복제 기능이 있는 MySQL/MariaDB
- **메시지 큐**: Apache Kafka 클러스터
- **컨테이너화**: 멀티 스테이지 빌드를 사용한 Docker
- **오케스트레이션**: 로컬 개발용 Docker Compose, 프로덕션용 Kubernetes/ECS
- **Python 라이브러리**: redis-py-cluster, asyncio, pydantic, sqlalchemy, pymysql, kafka-python

## 커뮤니케이션 가이드라인

- 모든 상호작용에서 영어와 한국어 모두로 응답하기
- CLAUDE.md는 영어로 유지하고 CLAUDE_KO.md를 한국어 버전으로 관리하기
- CLAUDE.md를 업데이트할 때 CLAUDE_KO.md도 한국어 번역으로 자동 업데이트하기

## 현재 구현 상태

### ✅ 완료된 기능
- **프로덕션 준비 아키텍처**: Redis 클러스터 + Kafka + MySQL + NGINX
- **원자적 연산**: Lua 스크립트를 사용한 경쟁 상태 없는 쿠폰 발급
- **고가용성**: 모든 중요 구성 요소에 대한 다중 노드 클러스터
- **캐시 우선 설계**: 핫 데이터를 위한 Redis, 영속성을 위한 MySQL
- **이벤트 주도 아키텍처**: 신뢰할 수 있는 비동기 처리를 위한 Kafka
- **속도 제한**: 토큰 버킷 알고리즘을 사용한 NGINX
- **수평적 확장**: 여러 앱 인스턴스에 걸친 로드 밸런싱

### 🔄 아키텍처 흐름
1. **요청**: 클라이언트 → NGINX (속도 제한) → FastAPI 앱
2. **캐시 확인**: 재고 및 사용자 참여에 대한 Redis 클러스터 조회
3. **원자적 연산**: Redis 클러스터에서 Lua 스크립트 실행
4. **즉각적인 응답**: 성공/실패가 클라이언트에게 즉시 반환
5. **비동기 영속성**: Kafka 이벤트 → 컨슈머 서비스 → MySQL 데이터베이스

### 🚀 배포
```bash
# 전체 시스템 시작
docker-compose up -d

# 서비스 상태 확인
curl http://localhost/health

# 쿠폰 발급
curl -X POST http://localhost/api/v1/coupons/issue \
  -H "Content-Type: application/json" \
  -d '{"user_id": "user123", "event_id": "sample_event"}'

# 이벤트 상태 확인
curl http://localhost/api/v1/coupons/status/sample_event
```

### 📊 시스템 용량
- **동시 사용자**: 100만 명 이상 (적절한 하드웨어 확장 시)
- **사용 가능한 쿠폰**: 이벤트당 1,000개
- **응답 시간**: 쿠폰 발급 시 100ms 미만
- **처리량**: 초당 10만 요청 이상 (속도 제한에 의해 제한됨)
- **고가용성**: 클러스터 설정으로 무중단 서비스